<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Token Manager</title>
    <!-- Prevent page flash: set initial display based on login status and Tab status before rendering -->
    <script>
        (function () {
            var isLoggedIn = localStorage.getItem('authToken');
            var currentTab = localStorage.getItem('currentTab') || 'tokens';
            var classes = ['auth-ready'];
            if (isLoggedIn) classes.push('logged-in');
            if (currentTab === 'settings') classes.push('tab-settings');
            document.documentElement.className = classes.join(' ');
            // Detect font loading
            if ('fonts' in document) {
                document.fonts.ready.then(function () {
                    document.documentElement.classList.add('fonts-loaded');
                });
            } else {
                // Fallback: add delayed
                setTimeout(function () {
                    document.documentElement.classList.add('fonts-loaded');
                }, 1000);
            }
        })();
    </script>
    <style>
        /* Key styles to prevent flash - from binary-build */
        html:not(.auth-ready) #loginForm,
        html:not(.auth-ready) #mainContent {
            visibility: hidden;
        }

        /* Login status display control - merge two branches */
        .logged-in #loginForm {
            display: none !important;
        }

        .logged-in #mainContent {
            display: flex !important;
        }

        html:not(.logged-in) #mainContent {
            display: none !important;
        }

        /* Tab status management - from binary-build */
        html.tab-settings #tokensPage {
            display: none !important;
        }

        html.tab-settings #settingsPage {
            display: block !important;
        }

        html.tab-settings .tab[data-tab="tokens"] {
            background: transparent !important;
            color: var(--text-light, #888) !important;
        }

        html.tab-settings .tab[data-tab="settings"] {
            background: var(--primary, #4f46e5) !important;
            color: white !important;
        }
    </style>
    <!-- Main stylesheet - load first -->
    <link rel="stylesheet" href="style.css">
    <!-- Preconnect font servers -->
    <link rel="preconnect" href="https://font.sec.miui.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Font async load - do not block rendering -->
    <link rel="stylesheet"
        href="https://font.sec.miui.com/font/css?family=MiSans:400,500,600,700:Chinese_Simplify,Latin&display=swap"
        media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:wght@400;700&display=swap"
        media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet"
            href="https://font.sec.miui.com/font/css?family=MiSans:400,500,600,700:Chinese_Simplify,Latin&display=swap">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:wght@400;700&display=swap">
    </noscript>
</head>

<body>
    <div class="container">
        <!-- Login Form -->
        <div id="loginForm" class="login-form">
            <h2>Token Manager</h2>
            <form id="login">
                <div class="form-group">
                    <label>üë§ Username</label>
                    <input type="text" id="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label>üîë Password</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit">Login</button>
            </form>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="main-content hidden">
            <div class="header">
                <div class="tabs">
                    <button class="tab active" data-tab="tokens" onclick="switchTab('tokens')">üéØ Tokens</button>
                    <button class="tab" data-tab="settings" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
                </div>
                <div class="header-right">
                    <button onclick="logout()">üö™ Logout</button>
                </div>
            </div>
            <div class="content">
                <!-- Token Management Page -->
                <div id="tokensPage">
                    <!-- Stats Card + Action Buttons Merged -->
                    <div class="top-bar">
                        <div class="stats-inline">
                            <div class="stat-item clickable active" onclick="filterTokens('all')">
                                <span class="stat-num" id="totalTokens">0</span>
                                <span class="stat-text">Total</span>
                            </div>
                            <div class="stat-item success clickable" onclick="filterTokens('enabled')">
                                <span class="stat-num" id="enabledTokens">0</span>
                                <span class="stat-text">Enabled</span>
                            </div>
                            <div class="stat-item danger clickable" onclick="filterTokens('disabled')">
                                <span class="stat-num" id="disabledTokens">0</span>
                                <span class="stat-text">Disabled</span>
                            </div>
                        </div>
                        <div class="action-btns">
                            <button type="button" onclick="showOAuthModal()" class="btn btn-success btn-sm">üîê
                                OAuth</button>
                            <button type="button" onclick="showManualModal()" class="btn btn-secondary btn-sm">‚úèÔ∏è
                                Manual</button>
                            <button type="button" onclick="loadTokens()" class="btn btn-warning btn-sm">üîÑ
                                Refresh</button>
                            <button type="button" onclick="toggleSensitiveInfo()" class="btn btn-sm"
                                id="toggleSensitiveBtn" title="Hide/Show Sensitive Info">üëÅÔ∏è Show</button>
                        </div>
                    </div>

                    <!-- Token Grid -->
                    <div id="tokenList" class="token-grid">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <div class="empty-state-text">No Tokens</div>
                            <div class="empty-state-hint">Click OAuth button above to add Token</div>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settingsPage" class="hidden">
                    <form id="configForm" class="config-form">
                        <div class="config-grid">
                            <!-- Server Config -->
                            <div class="config-section">
                                <h4>üñ•Ô∏è Server</h4>
                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Port</label>
                                        <input type="number" name="PORT" placeholder="8045">
                                    </div>
                                    <div class="form-group compact">
                                        <label>Host</label>
                                        <input type="text" name="HOST" placeholder="0.0.0.0">
                                    </div>
                                </div>
                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Max Request Size</label>
                                        <input type="text" name="MAX_REQUEST_SIZE" placeholder="500mb">
                                    </div>
                                    <div class="form-group compact">
                                        <label>API Key</label>
                                        <input type="password" name="API_KEY" placeholder="Leave blank to disable">
                                    </div>
                                </div>
                                <div class="form-row-inline switch-row">
                                    <div class="form-group compact switch-group">
                                        <label>Skip Validation <span class="help-tip"
                                                data-tooltip="Skip ProjectId fetch, generate randomly (Pro account only)">?</span></label>
                                        <label class="switch">
                                            <input type="checkbox" name="SKIP_PROJECT_ID_FETCH">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="form-group compact switch-group">
                                        <label>Native Axios <span class="help-tip"
                                                data-tooltip="Use native axios instead of TLS fingerprint requester">?</span></label>
                                        <label class="switch">
                                            <input type="checkbox" name="USE_NATIVE_AXIOS">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group compact">
                                    <label>Image Base URL</label>
                                    <input type="text" name="IMAGE_BASE_URL"
                                        placeholder="https://your-domain.zeabur.app">
                                </div>
                                <div class="form-group compact">
                                    <label>Proxy</label>
                                    <input type="text" name="PROXY" placeholder="http://127.0.0.1:7890">
                                </div>
                            </div>

                            <!-- Model Default Params -->
                            <div class="config-section">
                                <h4>üéõÔ∏è Model Params</h4>
                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Temperature</label>
                                        <input type="number" step="0.1" name="DEFAULT_TEMPERATURE" placeholder="1">
                                    </div>
                                    <div class="form-group compact">
                                        <label>Top P</label>
                                        <input type="number" step="0.01" name="DEFAULT_TOP_P" placeholder="1">
                                    </div>
                                </div>
                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Top K</label>
                                        <input type="number" name="DEFAULT_TOP_K" placeholder="50">
                                    </div>
                                    <div class="form-group compact">
                                        <label>Max Tokens</label>
                                        <input type="number" name="DEFAULT_MAX_TOKENS" placeholder="32000">
                                    </div>
                                </div>
                                <div class="form-group compact highlight">
                                    <label>Thinking Budget <span class="help-tip"
                                            data-tooltip="Thinking token budget for reasoning models, affects reasoning depth">?</span></label>
                                    <input type="number" name="DEFAULT_THINKING_BUDGET" placeholder="16000">
                                </div>
                                <div class="form-row-inline switch-row">
                                    <div class="form-group compact switch-group">
                                        <label>Context System <span class="help-tip"
                                                data-tooltip="Merge consecutive system messages at the start into SystemInstruction">?</span></label>
                                        <label class="switch">
                                            <input type="checkbox" name="USE_CONTEXT_SYSTEM_PROMPT">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group compact">
                                    <label>System Instruction</label>
                                    <textarea name="SYSTEM_INSTRUCTION" rows="3"
                                        placeholder="Optional system instruction"></textarea>
                                </div>
                            </div>

                            <!-- Rotation Strategy & Performance -->
                            <div class="config-section">
                                <h4>üîÑ Rotation & Performance</h4>
                                <div class="form-row-inline switch-row">
                                    <div class="form-group compact switch-group">
                                        <label>Pass Signature <span class="help-tip"
                                                data-tooltip="Pass thoughtSignature in response to client">?</span></label>
                                        <label class="switch">
                                            <input type="checkbox" name="PASS_SIGNATURE_TO_CLIENT">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Strategy <span class="help-tip"
                                                data-tooltip="Load Balance: Switch on every request&#10;Quota Exhausted: Switch when quota used up&#10;Request Count: Switch after N requests">?</span></label>
                                        <select name="ROTATION_STRATEGY" id="rotationStrategy"
                                            onchange="toggleRequestCountInput()">
                                            <option value="round_robin">Load Balance</option>
                                            <option value="quota_exhausted">Quota Exhausted</option>
                                            <option value="request_count">Request Count</option>
                                        </select>
                                    </div>
                                    <div class="form-group compact" id="requestCountGroup">
                                        <label>Requests per Token <span class="help-tip"
                                                data-tooltip="Switch after handling this many requests per token (Custom Count mode)">?</span></label>
                                        <input type="number" name="ROTATION_REQUEST_COUNT" min="1" placeholder="10">
                                    </div>
                                </div>
                                <div class="rotation-status" id="rotationStatus">
                                    <span class="rotation-label">Current Status:</span>
                                    <span id="currentRotationInfo">Loading...</span>
                                </div>
                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Timeout (ms)</label>
                                        <input type="number" name="TIMEOUT" placeholder="300000">
                                    </div>
                                    <div class="form-group compact">
                                        <label>429 Retries</label>
                                        <input type="number" name="RETRY_TIMES" placeholder="0">
                                    </div>
                                </div>

                                <div class="form-row-inline">
                                    <div class="form-group compact">
                                        <label>Heartbeat (ms) <span class="help-tip"
                                                data-tooltip="SSE heartbeat interval to prevent CF timeouts">?</span></label>
                                        <input type="number" name="HEARTBEAT_INTERVAL" placeholder="15000">
                                    </div>
                                    <div class="form-group compact">
                                        <label>Memory Threshold (MB) <span class="help-tip"
                                                data-tooltip="Trigger GC when exceeding this value">?</span></label>
                                        <input type="number" name="MEMORY_THRESHOLD" placeholder="100">
                                    </div>
                                </div>
                                <div class="form-group compact">
                                    <label>üî§ Font Size (px)</label>
                                    <div class="font-size-control">
                                        <input type="range" id="fontSizeRange" min="10" max="24" value="18"
                                            oninput="changeFontSize(this.value)">
                                        <input type="number" id="fontSizeInput" min="10" max="24" value="18"
                                            onchange="changeFontSize(this.value)" style="width: 60px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="config-actions">
                            <button type="submit" class="btn btn-success">üíæ Save Config</button>
                            <button type="button" onclick="loadConfig()" class="btn btn-secondary">üîÑ Reload</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Load modules in dependency order -->
    <script src="js/utils.js" defer></script>
    <script src="js/ui.js" defer></script>
    <script src="js/auth.js" defer></script>
    <script src="js/quota.js" defer></script>
    <script src="js/tokens.js" defer></script>
    <script src="js/config.js" defer></script>
    <script src="js/main.js" defer></script>
</body>

</html>